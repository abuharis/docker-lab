name: Create Bootcamp Users

on:
  workflow_dispatch:
    inputs:
      usernames:
        description: "Comma-separated Linux usernames (e.g. student1,student2)"
        required: true

jobs:
  create-users:
    runs-on: ubuntu-latest

    steps:
      - name: Create users on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /etc/skel/.docker
            sudo cp -r /home/${{ secrets.EC2_USER }}/.docker/* /etc/skel/.docker/ || true
            set -e

            USER_LIST="${{ github.event.inputs.usernames }}"

            IFS=',' read -ra USERS <<< "$USER_LIST"

            for USER in "${USERS[@]}"; do
              USER=$(echo "$USER" | xargs)   # trim spaces

              if id "$USER" &>/dev/null; then
                echo "User $USER already exists â€” skipping"
              else
                echo "Creating user: $USER"
                sudo useradd -m -s /bin/bash "$USER"
                sudo usermod -aG docker "$USER"
                sudo chown -R "$USER:$USER" "/home/$USER"
              fi
            done