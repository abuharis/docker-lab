name: Run Docker Container from Image URI

on:
  workflow_dispatch:
    inputs:
      image_uri:
        description: "Full Docker image URI (including tag)"
        required: true
      container_name:
        description: "Docker container name"
        required: true
      host_port:
        description: "Host port"
        required: true
        default: "80"
      container_port:
        description: "Container port"
        required: true
        default: "5000"

jobs:
  run-container:
    runs-on: ubuntu-latest

    steps:
      - name: Run container on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "Logging in to Amazon ECR..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
            | docker login --username AWS --password-stdin $(echo "${{ inputs.image_uri }}" | cut -d/ -f1)

            echo "Pulling image..."
            docker pull ${{ inputs.image_uri }}

            echo "Stopping existing container if any..."
            docker stop ${{ inputs.container_name }} || true
            docker rm ${{ inputs.container_name }} || true

            echo "Running container..."
            docker run -d \
              --name ${{ inputs.container_name }} \
              -p ${{ inputs.host_port }}:${{ inputs.container_port }} \
              ${{ inputs.image_uri }}

            echo "Container started successfully"